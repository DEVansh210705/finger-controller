<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Hand Gesture Servo Control</title>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
  video, canvas { transform: scaleX(-1); } /* mirror */
</style>
</head>
<body>
<h2>Hand Gesture Servo Control</h2>
<video id="video" width="640" height="480" autoplay muted></video>
<canvas id="canvas" width="640" height="480"></canvas>

<script>
  // Firebase config
 const firebaseConfig = {
  apiKey: "AIzaSyCXVWHtb7hYH7E_ur26D3ZXXeNHAmlZ_7Y",
  authDomain: "first-15b8e.firebaseapp.com",
  databaseURL: "https://first-15b8e-default-rtdb.firebaseio.com",
  projectId: "first-15b8e",
  storageBucket: "first-15b8e.firebasestorage.app",
  messagingSenderId: "1029885755729",
  appId: "1:1029885755729:web:1e4bbfeab7fffd52ebd370",
  measurementId: "G-T07VXFWPCK"
};

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Setup video & canvas
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  // Access webcam
  navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
    video.srcObject = stream;
  });

  // MediaPipe Hands setup
  const hands = new Hands({locateFile: (file) => {
    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
  }});
  hands.setOptions({
    maxNumHands: 1,
    minDetectionConfidence: 0.7,
    minTrackingConfidence: 0.7
  });

  hands.onResults(onResults);

  async function detectHands() {
    await hands.send({image: video});
    requestAnimationFrame(detectHands);
  }

  function onResults(results) {
    ctx.save();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
      const landmarks = results.multiHandLandmarks[0];

      // Draw landmarks
      drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
      drawLandmarks(ctx, landmarks, {color: '#FF0000', lineWidth: 2});

      // Calculate fingers up
      const fingerTipsIds = [4, 8, 12, 16, 20];
      let fingersUp = 0;
      for(let i = 0; i < fingerTipsIds.length; i++){
        let tip = landmarks[fingerTipsIds[i]];
        let pip = landmarks[fingerTipsIds[i] - 2];
        if(tip.y < pip.y) fingersUp++;
      }

      // Map fingers count to angle
      const angleMap = {0:0,1:30,2:60,3:90,4:120,5:150};
      const angle = angleMap[fingersUp] || 0;

      // Update angle to Firebase
      db.ref('/servo_angle').set(angle);

      // Display text
      ctx.font = "30px Arial";
      ctx.fillStyle = "yellow";
      ctx.fillText(`Fingers: ${fingersUp} Angle: ${angle}`, 10, 40);
    }
    ctx.restore();
  }

  video.onloadeddata = () => {
    detectHands();
  };
</script>
</body>
</html>
